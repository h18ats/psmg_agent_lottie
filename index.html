<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Lottie · PSMG Summit Assistant</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="light dark">
    <style>
      /* ===== PSMG look & feel ===== */
      :root{
        --psmg-navy:#0b1f3b;
        --psmg-navy-2:#102a52;
        --psmg-blue:#3b82f6;
        --ink:#0f172a;
        --muted:#64748b;
        --bg:#f4f6fb;
        --card:#ffffff;
        --border:#e5e7eb;
      }
      *{box-sizing:border-box}
      html,body{margin:0;padding:0}
      body{
        font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
        background:var(--bg);
        color:var(--ink);
        line-height:1.6;
      }

      /* Header */
      .header{
        background:linear-gradient(180deg,var(--psmg-navy),var(--psmg-navy-2));
        padding:20px 16px;
        border-bottom:1px solid rgba(255,255,255,.12);
      }
      .header .wrap{
        max-width:960px;margin:0 auto;display:flex;align-items:center;gap:16px;
      }
      .logo{
        display:block;width:auto;max-height:56px;border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,.15);
        background:#fff
      }
      .brand-title{
        color:#e6eefb;font-weight:700;letter-spacing:.3px;margin:0;font-size:18px
      }

      /* Main container */
      .main{max-width:960px;margin:26px auto;padding:0 16px}
      .hero{
        display:grid;grid-template-columns:1.05fr .95fr;gap:22px;align-items:center;
      }
      .card{
        background:var(--card);border:1px solid var(--border);border-radius:14px;
        box-shadow:0 10px 24px rgba(15,23,42,.06);
      }
      .card-pad{padding:18px}
      .badge{
        display:inline-block;padding:6px 10px;border-radius:999px;
        background:#e0ecff;border:1px solid #cfe0ff;color:#0b1f3b;font-size:12px
      }
      h1{margin:.4rem 0 .2rem;font-size:clamp(24px,4vw,32px);line-height:1.2;color:var(--psmg-navy)}
      .lead{color:#334155;font-size:16px;margin:0 0 10px}
      .muted{color:var(--muted);font-size:14px}
      .cta{
        display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
      }
      .btn{
        display:inline-flex;align-items:center;justify-content:center;
        padding:12px 16px;border-radius:10px;text-decoration:none;font-weight:700;
        border:1px solid transparent;cursor:pointer
      }
      .btn.primary{background:var(--psmg-blue);color:#fff}
      .btn.ghost{background:#e0ecff;color:var(--psmg-navy);border-color:#cfe0ff}

      /* Widget container */
      .widget-shell{padding:0}
      .widget-head{
        padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center
      }
      .widget-body{padding:14px 18px}
      .foot{
        margin:22px auto 28px;max-width:960px;padding:0 16px;color:var(--muted);font-size:13px;text-align:center
      }

      /* Responsive */
      @media (max-width: 900px){
        .hero{grid-template-columns:1fr}
      }

      /* Dark mode tweaks */
      @media (prefers-color-scheme:dark){
        :root{
          --bg:#0b1329; --card:#121a34; --border:#2a3865; --ink:#e8eef7; --muted:#a9b5d2;
        }
        .logo{background:#fff}
      }
    </style>
  </head>
  <body>
    <!-- ===== Header ===== -->
    <header class="header">
      <div class="wrap">
        <a href="https://www.psmg.co.uk/" target="_blank" rel="noopener">
          <img class="logo" src="https://www.psmg.co.uk/images/~resized-300x200/~resized-strch-download.jpg" alt="PSMG Logo" height="56">
        </a>
        <h1 class="brand-title">PSMG Summit Assistant</h1>
      </div>
    </header>

    <!-- ===== Main ===== -->
    <main class="main">
      <section class="hero">
        <!-- Left: intro -->
        <div class="card card-pad">
          <span class="badge">2025 London Summit · Reinvention</span>
          <h1>Talk to Lottie</h1>
          <p class="lead">
            Share your interests, logistics and preferences ahead of the Summit so we can tailor your day.
          </p>
          <p class="muted">
            If you arrived from our email, your details should pre-fill automatically. Otherwise you can proceed and Lottie will confirm who she’s speaking with.
          </p>
          <div class="cta">
            <a class="btn primary" href="#start">Start now</a>
            <a class="btn ghost" href="https://www.psmg.co.uk/Events/" target="_blank" rel="noopener">Event info</a>
          </div>
        </div>

        <!-- Right: widget -->
        <div id="start" class="card widget-shell">
          <div class="widget-head">
            <strong style="color:var(--psmg-navy)">Live assistant</strong>
            <span class="muted" id="who"></span>
          </div>
          <div class="widget-body">
            <!-- ElevenLabs Agent Widget -->
            <!-- We set dynamic variables + greeting via JS before the widget initializes -->
            <elevenlabs-convai
              id="psmgAgent"
              agent-id="agent_6901k5h1cvv7fbvtex52v0a60fn4">
            </elevenlabs-convai>
          </div>
        </div>
      </section>
    </main>

    <div class="foot">
      © 2025 PSMG · One Moorgate Place, London · Built with Legal Engine
    </div>

    <!-- ===== Behaviour / Personalisation ===== -->
    <script>
      (function () {
        // ------- Helpers
        var qs = new URLSearchParams(window.location.search);
        function getQ(keys){
          if (Array.isArray(keys)) { for (var i=0;i<keys.length;i++){ var v = qs.get(keys[i]); if(v) return v; } return ""; }
          return qs.get(keys) || "";
        }
        function s(v){ return String(v || "").replace(/[<>]/g, ""); }
        function splitName(full){
          full = (full || "").trim();
          if (!full) return { first:"", last:"" };
          var parts = full.split(/\s+/);
          var first = parts.shift() || "";
          var last  = parts.join(" ");
          return { first:first, last:last };
        }
        function uuid(){
          return 'cid_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
        }

        // ------- Read identity + UTM params
        var fullName = s(getQ(["name","full_name","fullname"]));
        var first    = s(getQ(["first","firstname","first_name","fname"]));
        var last     = s(getQ(["last","lastname","last_name","lname"]));
        var role     = s(getQ(["role","job_title","title","position"]));
        var company  = s(getQ(["company","organisation","organization"]));
        var email    = s(getQ(["email","e","mail"]));

        if ((!first || !last) && fullName) {
          var parts = splitName(fullName);
          first = first || parts.first;
          last  = last  || parts.last;
        }
        var normalizedName = (fullName || [first, last].filter(Boolean).join(" ")).trim();

        // UTMs (optional)
        var utm_source   = s(getQ(["utm_source","source"]));
        var utm_medium   = s(getQ(["utm_medium","medium"]));
        var utm_campaign = s(getQ(["utm_campaign","campaign"]));
        var utm_term     = s(getQ(["utm_term","term"]));
        var utm_content  = s(getQ(["utm_content","content"]));

        // Correlation id
        var client_id = s(getQ("client_id")) || (localStorage.getItem("psmg_client_id") || uuid());
        try { localStorage.setItem("psmg_client_id", client_id); } catch(e){}

        // ------- Dynamic variables for the Agent
        var dyn = {
          first_name: first || "",
          last_name:  last  || "",
          full_name:  normalizedName || "",
          role:       role || "",
          company:    company || "",
          email:      email || "",
          client_id:  client_id,
          utm_source:  utm_source || "",
          utm_medium:  utm_medium || "",
          utm_campaign:utm_campaign || "",
          utm_term:    utm_term || "",
          utm_content: utm_content || ""
        };

        // ------- Greeting logic
        var hasIdentity = !!(normalizedName || company);
        var defaultGreeting =
          "Hi there. I'm Lottie, one of the conference organisers here at PSMG. " +
          "We're super excited to have you on board this year. True to the theme of this year's conference, " +
          "we're continually finding ways to re-invent ourselves and have teamed up with Legal Engine to develop an agent " +
          "(that's me by the way) to get your thoughts and interests ahead of the conference and help with any travel arrangements. " +
          "May I please confirm who I'm speaking with?";

        var personalisedGreeting =
          "Hi " + (normalizedName ? normalizedName : "there") +
          (company ? " from " + company : "") +
          ". I'm Lottie, one of the conference organisers here at PSMG. We're super excited to have you on board this year. " +
          "True to the theme of this year's conference, we're continually finding ways to re-invent ourselves and have teamed up with Legal Engine " +
          "to develop an agent (that's me by the way) to get your thoughts and interests ahead of the conference and help with any travel arrangements. " +
          "Shall we get started?";

        var firstMessage = hasIdentity ? personalisedGreeting : defaultGreeting;

        // Show detected visitor (small, top-right of widget card)
        var who = document.getElementById("who");
        if (who && (normalizedName || company)) {
          who.textContent = [normalizedName, company ? "· " + company : ""].filter(Boolean).join(" ");
        }

        // ------- Apply to the widget BEFORE it initializes
        var widget = document.getElementById("psmgAgent");
        if (widget) {
          widget.setAttribute("dynamic-variables", JSON.stringify(dyn));
          widget.setAttribute("override-first-message", firstMessage);
        }

        // ------- Save to your n8n webhook for post-call summaries
        try {
          var payload = new URLSearchParams();
          payload.set("event", "landing_context");
          payload.set("client_id", client_id);
          payload.set("first_name", dyn.first_name);
          payload.set("last_name",  dyn.last_name);
          payload.set("full_name",  dyn.full_name);
          payload.set("role",       dyn.role);
          payload.set("company",    dyn.company);
          payload.set("email",      dyn.email);
          payload.set("utm_source", utm_source);
          payload.set("utm_medium", utm_medium);
          payload.set("utm_campaign", utm_campaign);
          payload.set("utm_term",   utm_term);
          payload.set("utm_content",utm_content);
          payload.set("page_url",   location.href);
          payload.set("referrer",   document.referrer || "");
          payload.set("user_agent", navigator.userAgent || "");

          fetch("https://leonard-dev.app.n8n.cloud/webhook/luke-pre-brief", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: payload.toString()
          }).catch(function(){});
        } catch (e) {
          console.warn("Pre-brief logging failed", e);
        }
      })();
    </script>

    <!-- ElevenLabs widget embed -->
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
  </body>
</html>
